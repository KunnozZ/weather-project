<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Map - Weather Forecast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@200;300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Prompt', sans-serif; background: #020617; color: white; margin: 0; overflow: hidden; }
        
        /* Navbar สไตล์เดียวกับหน้าแรกเพื่อให้ดูต่อเนื่อง */
        .glass { 
            background: rgba(15, 23, 42, 0.75); 
            backdrop-filter: blur(15px); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            transition: all 0.3s ease;
        }

        /* ตั้งค่าแผนที่ */
        #map { height: calc(100vh - 80px); width: 100%; z-index: 1; }

        /* ปุ่มเปลี่ยนธีมขวาบน */
        .theme-btn { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            z-index: 1000; 
            font-size: 0.75rem; 
            background: rgba(0,0,0,0.6); 
            color: white; 
            padding: 6px 12px; 
            border-radius: 99px; 
            border: 1px solid rgba(255,255,255,0.2); 
            transition: 0.3s;
            cursor: pointer;
        }
        .theme-btn:hover { background: white; color: black; transform: scale(1.05); }

        nav { animation: fadeInDown 0.6s ease-out; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <!-- Navbar (ต้องมี ID ตามที่ JS กำหนดไว้) -->
    <nav class="glass sticky top-0 z-[1001] flex justify-between items-center px-10 py-5">
        <div class="text-2xl font-bold italic text-blue-400">Weather.Forecast</div>
        <div class="hidden md:flex space-x-8 items-center" id="navbar-links">
            <a href="index.html" class="hover:text-blue-400 transition">Homepage</a>
            <a href="guide.html" class="hover:text-blue-400 transition">Guide</a>
            <a href="map.html" class="text-blue-400 border-b-2 border-blue-400 pb-1">Map</a>
            <a href="signin.html" class="hover:text-blue-400 transition" id="login-nav-link">Sign in</a>
            <a href="about.html" class="hover:text-blue-400 transition">About me</a>
        </div>
    </nav>

    <div class="relative">
        <button onclick="toggleMapTheme()" id="themeBtn" class="theme-btn shadow-2xl">
            <i class="fas fa-moon"></i> Dark Mode
        </button>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_KEY = '0a88acd34adcdee79f60f221f82d2331';
        let map = L.map('map').setView([13.75, 100.5], 6);
        let isDarkMode = false;

        // เตรียม Tiles 2 รูปแบบ
        const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
        const darkTiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
        
        // เริ่มด้วยแผนที่สีปกติ
        lightTiles.addTo(map);

        // แสดงเลเยอร์ฝน
        const rainLayer = L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${API_KEY}`, {
            opacity: 0.5,
            zIndex: 10
        });
        rainLayer.addTo(map);

        function toggleMapTheme() {
            const btn = document.getElementById('themeBtn');
            if (!isDarkMode) {
                map.removeLayer(lightTiles);
                darkTiles.addTo(map);
                btn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
                isDarkMode = true;
            } else {
                map.removeLayer(darkTiles);
                lightTiles.addTo(map);
                btn.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
                isDarkMode = false;
            }
            rainLayer.bringToFront();
        }

        // --- ระบบเช็ค User และ Logout (เพิ่มมาเพื่อแก้ปัญหาที่คุณเจอ) ---
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const userName = localStorage.getItem('userName');
            const navMenu = document.getElementById('navbar-links');
            const signInLink = document.getElementById('login-nav-link');

            if (isLoggedIn === 'true' && signInLink) {
                // เปลี่ยน Sign in เป็นชื่อ User
                signInLink.innerHTML = `<i class="fas fa-user-circle mr-1"></i>${userName}`;
                signInLink.href = "#";
                signInLink.style.color = "#60a5fa";
                signInLink.classList.remove('border-b-2'); // ลบเส้นใต้ออกเมื่อเป็น User

                // สร้างปุ่ม Logout
                const logoutBtn = document.createElement('a');
                logoutBtn.innerHTML = `Logout`;
                logoutBtn.className = "hover:text-red-400 cursor-pointer transition text-[10px] opacity-60 ml-4 uppercase tracking-tighter";
                
                logoutBtn.onclick = function() {
                    localStorage.clear(); // ล้างข้อมูล Login
                    window.location.href = "index.html"; // กลับหน้าแรก
                };
                navMenu.appendChild(logoutBtn);
            }
        }

        // เรียกทำงานทันทีที่หน้าเว็บโหลดเสร็จ
        window.onload = checkLoginStatus;
    </script>
</body>
</html>
